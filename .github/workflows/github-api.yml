name: Update Data File via API

on:
  workflow_dispatch:
    inputs:
      file_content:
        description: 'The full JSON content to write to data/data.json'
        required: true

jobs:
  update_json_file:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Install curl and jq
        run: sudo apt-get update && sudo apt-get install -y curl jq

      - name: Update data.json on GitHub
        env:
          TOKEN: ${{ secrets.TOKEN }}
          REPO_FULL_NAME: ${{ github.repository }}
          CONTENT: ${{ github.event.inputs.file_content }}
        run: |
          set -e # Exit on error
          FILEPATH="data/data.json"
          API_URL="https://api.github.com/repos/$REPO_FULL_NAME/contents/$FILEPATH"

          # 1. Get the current file's SHA
          RESPONSE=$(curl -s -H "Authorization: token $TOKEN" -H "Accept: application/vnd.github.v3+json" "$API_URL")
          SHA=$(echo "$RESPONSE" | jq -r '.sha')

          if [ "$SHA" = "null" ] || [ -z "$SHA" ]; then
            echo "Error: Could not retrieve SHA for $FILEPATH."
            echo "API Response: $RESPONSE"
            exit 1
          fi
          
          # 2. Base64 encode the new content. The -w 0 flag prevents line wrapping.
          ENCODED_CONTENT=$(echo -n "$CONTENT" | base64 -w 0)

          # 3. Create the JSON payload for the PUT request
          JSON_PAYLOAD=$(jq -n \
            --arg msg "Cập nhật dữ liệu lớp học qua web - $(date -u --iso-8601=seconds)" \
            --arg content "$ENCODED_CONTENT" \
            --arg sha "$SHA" \
            '{message: $msg, content: $content, sha: $sha}')

          # 4. Make the PUT request and capture the response for detailed error logging
          echo "Updating file..."
          HTTP_RESPONSE=$(curl -s -o response.json -w "%{http_code}" \
            -X PUT \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "$JSON_PAYLOAD" \
            "$API_URL")

          # 5. Check if the request was successful
          if [[ "$HTTP_RESPONSE" -lt 200 || "$HTTP_RESPONSE" -ge 300 ]]; then
            echo "::error::Failed to update file. GitHub API responded with status $HTTP_RESPONSE."
            echo "::error::Response body:"
            cat response.json
            exit 1
          else
            echo "File updated successfully. Status: $HTTP_RESPONSE"
          fi
